#!/usr/bin/env ruby
# -*- coding: utf-8 -*-

TOKEN_PATH = "#{ENV['HOME']}/.semaphore_token"

help = <<-MSG
This utility shows current status of your projects on Semaphore.

To set authentication token first time you must run "sst -t \'_your_token_\'".
After that you can simply call "sst" or provide name of project which status you want to see, like "sst <project_name>".
In interactive mode you will see live status of your build (updates every 5sec).

Options:
  -i    Interactive mode
  -t    Set authentication token
  -h    Print this help

Usage:  sst
        sst <project_name>
        sst -i
        sst -i <project_name> 
        sst -t <your_token>
        sst -h
MSG

if system('git rev-parse 2>/dev/null ')
  git_repo_cmd =  %q(git remote -v | head -n1 | awk '{print $2}' | sed 's/.*\///' | sed 's/\.git//')
  query = `#{git_repo_cmd}`.chomp
else
 query = nil
end

if i = ARGV.index('-t') or i = ARGV.index('--token')
  token = ARGV[i + 1]

  file = File.open(TOKEN_PATH, "w")
  file.write(token)

  puts 'Token successfully saved.' 
  exit
end

if ARGV.index('-h') or ARGV.index('--help')
  puts help
  exit
end

require "semaphore-status"

def get_projects(query = nil)
  sst = SemaphoreClient.new(ENV['SEMAPHORE_API_KEY'])
  if query
    sst.tree(query)
  else
    sst.tree
  end
end

unless ENV['SEMAPHORE_API_KEY']

  if !File.exist?(TOKEN_PATH)
    token = ''
    puts 'Please enter authentication token for your Semaphore account:'
    while token.lstrip.empty?
      token = gets.chomp
    end

    file = File.open(TOKEN_PATH, "w")
    file.write(token)
    ENV['SEMAPHORE_API_KEY'] = token

    puts 'Token successfully saved.' 

    get_projects(query)
    exit
  else
    key =  File.read(TOKEN_PATH).chomp
    if key.empty?
      puts 'Please provide new authentication token with: sst -t <your_token>.'
    else
      ENV['SEMAPHORE_API_KEY'] = key
    end 
  end
end

if ARGV.index('-a') or ARGV.index('--all')
  get_projects()
  exit
end

if i = ARGV.index('-i') or i = ARGV.index('--interactive')
  query = ARGV[i + 1]
  get_projects(query)

  exit
end

if ARGV.empty?
  get_projects(query)
else
  get_projects(ARGV[0])
end