#!/usr/bin/env ruby
# -*- coding: utf-8 -*-

help = <<-MSG
This utility shows current status of your projects on Semaphore.

To set authentication token first time you must run "sst -t \'_your_token_\'".
After that you can simply call "sst" or provide name of project which status you want to see, like "sst <project_name>".
In interactive mode you will see live status of your build (updates every 5sec).

Options:
  -i    Interactive mode
  -t    Set authentication token
  -h    Print this help

Usage:  sst
        sst <project_name>
        sst -i
        sst -i <project_name> 
        sst -t <your_token>
        sst -h
MSG

unless ENV['SEMAPHORE_API_KEY']
  puts 'Please provide authentication token for your Semaphore account with: "sst -t \'_your_token_\'" '
  exit
end

if ARGV.index('-h') or ARGV.index('--help')
  puts help
  exit
end

if i = ARGV.index('-t') or i = ARGV.index('--token')
  token = ARGV[i + 1]
  set_env_key(token)

  exit
end

require "semaphore-status"

if i = ARGV.index('-i') or i = ARGV.index('--interactive')
  query = ARGV[i + 1]
  get_projects(query)

  exit
end

if ARGV.empty?
  get_projects
  exit
else
  get_projects(ARGV[0])
  exit
end



private

def set_env_key(key)
  ENV['SEMAPHORE_API_KEY'] = key
end

def get_projects(query = nil)
  sst = SemaphoreClient.new('qH36J7zzMfAGG8xmF72f')
  if query.present?
    sst.tree
  else
    sst.tree query
  end
end